"use strict";var ChatbotBundle=(()=>{var Ae=Object.defineProperty;var Ce=(e,t,o)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var d=(e,t,o)=>Ce(e,typeof t!="symbol"?t+"":t,o);var R=new TextEncoder,E=new TextDecoder,Me=2**32;function z(...e){let t=e.reduce((n,{length:s})=>n+s,0),o=new Uint8Array(t),r=0;for(let n of e)o.set(n,r),r+=n.length;return o}function q(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(e);let t=atob(e),o=new Uint8Array(t.length);for(let r=0;r<t.length;r++)o[r]=t.charCodeAt(r);return o}function v(e){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof e=="string"?e:E.decode(e),{alphabet:"base64url"});let t=e;t instanceof Uint8Array&&(t=E.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return q(t)}catch(o){throw new TypeError("The input to be decoded is not correctly encoded.")}}var x=class extends Error{constructor(o,r){var n;super(o,r);d(this,"code","ERR_JOSE_GENERIC");this.name=this.constructor.name,(n=Error.captureStackTrace)==null||n.call(Error,this,this.constructor)}};d(x,"code","ERR_JOSE_GENERIC");var b=class extends x{constructor(o,r,n="unspecified",s="unspecified"){super(o,{cause:{claim:n,reason:s,payload:r}});d(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");d(this,"claim");d(this,"reason");d(this,"payload");this.claim=n,this.reason=s,this.payload=r}};d(b,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");var _=class extends x{constructor(o,r,n="unspecified",s="unspecified"){super(o,{cause:{claim:n,reason:s,payload:r}});d(this,"code","ERR_JWT_EXPIRED");d(this,"claim");d(this,"reason");d(this,"payload");this.claim=n,this.reason=s,this.payload=r}};d(_,"code","ERR_JWT_EXPIRED");var I=class extends x{constructor(){super(...arguments);d(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}};d(I,"code","ERR_JOSE_ALG_NOT_ALLOWED");var S=class extends x{constructor(){super(...arguments);d(this,"code","ERR_JOSE_NOT_SUPPORTED")}};d(S,"code","ERR_JOSE_NOT_SUPPORTED");var l=class extends x{constructor(){super(...arguments);d(this,"code","ERR_JWS_INVALID")}};d(l,"code","ERR_JWS_INVALID");var C=class extends x{constructor(){super(...arguments);d(this,"code","ERR_JWT_INVALID")}};d(C,"code","ERR_JWT_INVALID");var X,Y,B=class extends(Y=x,X=Symbol.asyncIterator,Y){constructor(o="multiple matching keys found in the JSON Web Key Set",r){super(o,r);d(this,X);d(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}};d(B,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");var D=class extends x{constructor(o="signature verification failed",r){super(o,r);d(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}};d(D,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function A(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function J(e,t){return e.name===t}function M(e){return parseInt(e.name.slice(4),10)}function Ke(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}function Te(e,t){if(t&&!e.usages.includes(t))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${t}.`)}function Z(e,t,o){switch(t){case"HS256":case"HS384":case"HS512":{if(!J(e.algorithm,"HMAC"))throw A("HMAC");let r=parseInt(t.slice(2),10);if(M(e.algorithm.hash)!==r)throw A(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!J(e.algorithm,"RSASSA-PKCS1-v1_5"))throw A("RSASSA-PKCS1-v1_5");let r=parseInt(t.slice(2),10);if(M(e.algorithm.hash)!==r)throw A(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!J(e.algorithm,"RSA-PSS"))throw A("RSA-PSS");let r=parseInt(t.slice(2),10);if(M(e.algorithm.hash)!==r)throw A(`SHA-${r}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":{if(!J(e.algorithm,"Ed25519"))throw A("Ed25519");break}case"ES256":case"ES384":case"ES512":{if(!J(e.algorithm,"ECDSA"))throw A("ECDSA");let r=Ke(t);if(e.algorithm.namedCurve!==r)throw A(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}Te(e,o)}function Q(e,t,...o){var r;if(o=o.filter(Boolean),o.length>2){let n=o.pop();e+=`one of type ${o.join(", ")}, or ${n}.`}else o.length===2?e+=`one of type ${o[0]} or ${o[1]}.`:e+=`of type ${o[0]}.`;return t==null?e+=` Received ${t}`:typeof t=="function"&&t.name?e+=` Received function ${t.name}`:typeof t=="object"&&t!=null&&(r=t.constructor)!=null&&r.name&&(e+=` Received an instance of ${t.constructor.name}`),e}var j=(e,...t)=>Q("Key must be ",e,...t);function $(e,t,...o){return Q(`Key for the ${e} algorithm must be `,t,...o)}function F(e){return(e==null?void 0:e[Symbol.toStringTag])==="CryptoKey"}function U(e){return(e==null?void 0:e[Symbol.toStringTag])==="KeyObject"}var N=e=>F(e)||U(e);var ee=(...e)=>{let t=e.filter(Boolean);if(t.length===0||t.length===1)return!0;let o;for(let r of t){let n=Object.keys(r);if(!o||o.size===0){o=new Set(n);continue}for(let s of n){if(o.has(s))return!1;o.add(s)}}return!0};function Re(e){return typeof e=="object"&&e!==null}var K=e=>{if(!Re(e)||Object.prototype.toString.call(e)!=="[object Object]")return!1;if(Object.getPrototypeOf(e)===null)return!0;let t=e;for(;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t};var te=(e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){let{modulusLength:o}=t.algorithm;if(typeof o!="number"||o<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}};function ve(e){let t,o;switch(e.kty){case"RSA":{switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},o=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},o=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},o=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new S('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},o=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},o=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},o=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},o=e.d?["deriveBits"]:[];break;default:throw new S('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(e.alg){case"Ed25519":case"EdDSA":t={name:"Ed25519"},o=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},o=e.d?["deriveBits"]:[];break;default:throw new S('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new S('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:o}}var re=async e=>{var n,s;if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');let{algorithm:t,keyUsages:o}=ve(e),r={...e};return delete r.alg,delete r.use,crypto.subtle.importKey("jwk",r,t,(n=e.ext)!=null?n:!e.d,(s=e.key_ops)!=null?s:o)};var oe=(e,t,o,r,n)=>{if(n.crit!==void 0&&(r==null?void 0:r.crit)===void 0)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!r||r.crit===void 0)return new Set;if(!Array.isArray(r.crit)||r.crit.length===0||r.crit.some(i=>typeof i!="string"||i.length===0))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let s;o!==void 0?s=new Map([...Object.entries(o),...t.entries()]):s=t;for(let i of r.crit){if(!s.has(i))throw new S(`Extension Header Parameter "${i}" is not recognized`);if(n[i]===void 0)throw new e(`Extension Header Parameter "${i}" is missing`);if(s.get(i)&&r[i]===void 0)throw new e(`Extension Header Parameter "${i}" MUST be integrity protected`)}return new Set(r.crit)};var ne=(e,t)=>{if(t!==void 0&&(!Array.isArray(t)||t.some(o=>typeof o!="string")))throw new TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};function H(e){return K(e)&&typeof e.kty=="string"}function se(e){return e.kty!=="oct"&&typeof e.d=="string"}function ie(e){return e.kty!=="oct"&&typeof e.d=="undefined"}function ae(e){return e.kty==="oct"&&typeof e.k=="string"}var P,ce=async(e,t,o,r=!1)=>{P||(P=new WeakMap);let n=P.get(e);if(n!=null&&n[o])return n[o];let s=await re({...t,alg:o});return r&&Object.freeze(e),n?n[o]=s:P.set(e,{[o]:s}),s},Pe=(e,t)=>{var i;P||(P=new WeakMap);let o=P.get(e);if(o!=null&&o[t])return o[t];let r=e.type==="public",n=!!r,s;if(e.asymmetricKeyType==="x25519"){switch(t){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}s=e.toCryptoKey(e.asymmetricKeyType,n,r?[]:["deriveBits"])}if(e.asymmetricKeyType==="ed25519"){if(t!=="EdDSA"&&t!=="Ed25519")throw new TypeError("given KeyObject instance cannot be used for this algorithm");s=e.toCryptoKey(e.asymmetricKeyType,n,[r?"verify":"sign"])}if(e.asymmetricKeyType==="rsa"){let c;switch(t){case"RSA-OAEP":c="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":c="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":c="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":c="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(t.startsWith("RSA-OAEP"))return e.toCryptoKey({name:"RSA-OAEP",hash:c},n,r?["encrypt"]:["decrypt"]);s=e.toCryptoKey({name:t.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:c},n,[r?"verify":"sign"])}if(e.asymmetricKeyType==="ec"){let a=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get((i=e.asymmetricKeyDetails)==null?void 0:i.namedCurve);if(!a)throw new TypeError("given KeyObject instance cannot be used for this algorithm");t==="ES256"&&a==="P-256"&&(s=e.toCryptoKey({name:"ECDSA",namedCurve:a},n,[r?"verify":"sign"])),t==="ES384"&&a==="P-384"&&(s=e.toCryptoKey({name:"ECDSA",namedCurve:a},n,[r?"verify":"sign"])),t==="ES512"&&a==="P-521"&&(s=e.toCryptoKey({name:"ECDSA",namedCurve:a},n,[r?"verify":"sign"])),t.startsWith("ECDH-ES")&&(s=e.toCryptoKey({name:"ECDH",namedCurve:a},n,r?[]:["deriveBits"]))}if(!s)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return o?o[t]=s:P.set(e,{[t]:s}),s},de=async(e,t)=>{if(e instanceof Uint8Array||F(e))return e;if(U(e)){if(e.type==="secret")return e.export();if("toCryptoKey"in e&&typeof e.toCryptoKey=="function")try{return Pe(e,t)}catch(r){if(r instanceof TypeError)throw r}let o=e.export({format:"jwk"});return ce(e,o,t)}if(H(e))return e.k?v(e.k):ce(e,e,t,!0);throw new Error("unreachable")};var W=e=>e==null?void 0:e[Symbol.toStringTag],L=(e,t,o)=>{var r,n;if(t.use!==void 0){let s;switch(o){case"sign":case"verify":s="sig";break;case"encrypt":case"decrypt":s="enc";break}if(t.use!==s)throw new TypeError(`Invalid key for this operation, its "use" must be "${s}" when present`)}if(t.alg!==void 0&&t.alg!==e)throw new TypeError(`Invalid key for this operation, its "alg" must be "${e}" when present`);if(Array.isArray(t.key_ops)){let s;switch(!0){case(o==="sign"||o==="verify"):case e==="dir":case e.includes("CBC-HS"):s=o;break;case e.startsWith("PBES2"):s="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(e):!e.includes("GCM")&&e.endsWith("KW")?s=o==="encrypt"?"wrapKey":"unwrapKey":s=o;break;case(o==="encrypt"&&e.startsWith("RSA")):s="wrapKey";break;case o==="decrypt":s=e.startsWith("RSA")?"unwrapKey":"deriveBits";break}if(s&&((n=(r=t.key_ops)==null?void 0:r.includes)==null?void 0:n.call(r,s))===!1)throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${s}" when present`)}return!0},We=(e,t,o)=>{if(!(t instanceof Uint8Array)){if(H(t)){if(ae(t)&&L(e,t,o))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!N(t))throw new TypeError($(e,t,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if(t.type!=="secret")throw new TypeError(`${W(t)} instances for symmetric algorithms must be of type "secret"`)}},Ie=(e,t,o)=>{if(H(t))switch(o){case"decrypt":case"sign":if(se(t)&&L(e,t,o))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(ie(t)&&L(e,t,o))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!N(t))throw new TypeError($(e,t,"CryptoKey","KeyObject","JSON Web Key"));if(t.type==="secret")throw new TypeError(`${W(t)} instances for asymmetric algorithms must not be of type "secret"`);if(t.type==="public")switch(o){case"sign":throw new TypeError(`${W(t)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${W(t)} instances for asymmetric algorithm decryption must be of type "private"`);default:break}if(t.type==="private")switch(o){case"verify":throw new TypeError(`${W(t)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${W(t)} instances for asymmetric algorithm encryption must be of type "public"`);default:break}},pe=(e,t,o)=>{e.startsWith("HS")||e==="dir"||e.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(e)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(e)?We(e,t,o):Ie(e,t,o)};var le=(e,t)=>{let o=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:o,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:o,name:"RSA-PSS",saltLength:parseInt(e.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:o,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:o,name:"ECDSA",namedCurve:t.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};default:throw new S(`alg ${e} is not supported either by JOSE or your javascript runtime`)}};var fe=async(e,t,o)=>{if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(j(t,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[o])}return Z(t,e,o),t};var ue=async(e,t,o,r)=>{let n=await fe(e,t,"verify");te(e,n);let s=le(e,n.algorithm);try{return await crypto.subtle.verify(s,n,o,r)}catch(i){return!1}};async function me(e,t,o){var p;if(!K(e))throw new l("Flattened JWS must be an object");if(e.protected===void 0&&e.header===void 0)throw new l('Flattened JWS must have either of the "protected" or "header" members');if(e.protected!==void 0&&typeof e.protected!="string")throw new l("JWS Protected Header incorrect type");if(e.payload===void 0)throw new l("JWS Payload missing");if(typeof e.signature!="string")throw new l("JWS Signature missing or incorrect type");if(e.header!==void 0&&!K(e.header))throw new l("JWS Unprotected Header incorrect type");let r={};if(e.protected)try{let T=v(e.protected);r=JSON.parse(E.decode(T))}catch(T){throw new l("JWS Protected Header is invalid")}if(!ee(r,e.header))throw new l("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let n={...r,...e.header},s=oe(l,new Map([["b64",!0]]),o==null?void 0:o.crit,r,n),i=!0;if(s.has("b64")&&(i=r.b64,typeof i!="boolean"))throw new l('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:c}=n;if(typeof c!="string"||!c)throw new l('JWS "alg" (Algorithm) Header Parameter missing or invalid');let a=o&&ne("algorithms",o.algorithms);if(a&&!a.has(c))throw new I('"alg" (Algorithm) Header Parameter value not allowed');if(i){if(typeof e.payload!="string")throw new l("JWS Payload must be a string")}else if(typeof e.payload!="string"&&!(e.payload instanceof Uint8Array))throw new l("JWS Payload must be a string or an Uint8Array instance");let f=!1;typeof t=="function"&&(t=await t(r,e),f=!0),pe(c,t,"verify");let w=z(R.encode((p=e.protected)!=null?p:""),R.encode("."),typeof e.payload=="string"?R.encode(e.payload):e.payload),h;try{h=v(e.signature)}catch(T){throw new l("Failed to base64url decode the signature")}let u=await de(t,c);if(!await ue(c,u,h,w))throw new D;let y;if(i)try{y=v(e.payload)}catch(T){throw new l("Failed to base64url decode the payload")}else typeof e.payload=="string"?y=R.encode(e.payload):y=e.payload;let g={payload:y};return e.protected!==void 0&&(g.protectedHeader=r),e.header!==void 0&&(g.unprotectedHeader=e.header),f?{...g,key:u}:g}async function he(e,t,o){if(e instanceof Uint8Array&&(e=E.decode(e)),typeof e!="string")throw new l("Compact JWS must be a string or Uint8Array");let{0:r,1:n,2:s,length:i}=e.split(".");if(i!==3)throw new l("Invalid Compact JWS");let c=await me({payload:n,protected:r,signature:s},t,o),a={payload:c.payload,protectedHeader:c.protectedHeader};return typeof t=="function"?{...a,key:c.key}:a}var ye=e=>Math.floor(e.getTime()/1e3);var De=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,k=e=>{let t=De.exec(e);if(!t||t[4]&&t[1])throw new TypeError("Invalid time period format");let o=parseFloat(t[2]),r=t[3].toLowerCase(),n;switch(r){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(o);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(o*60);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(o*3600);break;case"day":case"days":case"d":n=Math.round(o*86400);break;case"week":case"weeks":case"w":n=Math.round(o*604800);break;default:n=Math.round(o*31557600);break}return t[1]==="-"||t[4]==="ago"?-n:n};var be=e=>e.includes("/")?e.toLowerCase():`application/${e.toLowerCase()}`,Je=(e,t)=>typeof e=="string"?t.includes(e):Array.isArray(e)?t.some(Set.prototype.has.bind(new Set(e))):!1;function we(e,t,o={}){let r;try{r=JSON.parse(E.decode(t))}catch(y){}if(!K(r))throw new C("JWT Claims Set must be a top-level JSON object");let{typ:n}=o;if(n&&(typeof e.typ!="string"||be(e.typ)!==be(n)))throw new b('unexpected "typ" JWT header value',r,"typ","check_failed");let{requiredClaims:s=[],issuer:i,subject:c,audience:a,maxTokenAge:f}=o,w=[...s];f!==void 0&&w.push("iat"),a!==void 0&&w.push("aud"),c!==void 0&&w.push("sub"),i!==void 0&&w.push("iss");for(let y of new Set(w.reverse()))if(!(y in r))throw new b(`missing required "${y}" claim`,r,y,"missing");if(i&&!(Array.isArray(i)?i:[i]).includes(r.iss))throw new b('unexpected "iss" claim value',r,"iss","check_failed");if(c&&r.sub!==c)throw new b('unexpected "sub" claim value',r,"sub","check_failed");if(a&&!Je(r.aud,typeof a=="string"?[a]:a))throw new b('unexpected "aud" claim value',r,"aud","check_failed");let h;switch(typeof o.clockTolerance){case"string":h=k(o.clockTolerance);break;case"number":h=o.clockTolerance;break;case"undefined":h=0;break;default:throw new TypeError("Invalid clockTolerance option type")}let{currentDate:u}=o,m=ye(u||new Date);if((r.iat!==void 0||f)&&typeof r.iat!="number")throw new b('"iat" claim must be a number',r,"iat","invalid");if(r.nbf!==void 0){if(typeof r.nbf!="number")throw new b('"nbf" claim must be a number',r,"nbf","invalid");if(r.nbf>m+h)throw new b('"nbf" claim timestamp check failed',r,"nbf","check_failed")}if(r.exp!==void 0){if(typeof r.exp!="number")throw new b('"exp" claim must be a number',r,"exp","invalid");if(r.exp<=m-h)throw new _('"exp" claim timestamp check failed',r,"exp","check_failed")}if(f){let y=m-r.iat,g=typeof f=="number"?f:k(f);if(y-h>g)throw new _('"iat" claim timestamp check failed (too far in the past)',r,"iat","check_failed");if(y<0-h)throw new b('"iat" claim timestamp check failed (it should be in the past)',r,"iat","check_failed")}return r}async function V(e,t,o){var i;let r=await he(e,t,o);if((i=r.protectedHeader.crit)!=null&&i.includes("b64")&&r.protectedHeader.b64===!1)throw new C("JWTs MUST NOT use unencoded payload");let s={payload:we(r.protectedHeader,r.payload,o),protectedHeader:r.protectedHeader};return typeof t=="function"?{...s,key:r.key}:s}async function He(e,t){try{let{payload:o}=await V(e,new TextEncoder().encode(t));return o}catch(o){return null}}window.Chatbot={init:async function(e){let t={...Oe(),...e};if(t.jwt){let r=await He(t.jwt,"sk_prod_38djfheyr3847hdsf8383dhfbsf83");r&&r.premium?t={...t,...r}:(t.premium=!1,t.logoUrl="",t.footer=void 0,t.showFooter=void 0)}let o=t.theme;o==="auto"&&(o=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),t._resolvedTheme=o,t._themeColors={...ge(o),...t.themeColors||{}},Ee(t),t.theme==="auto"&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",r=>{let n=r.matches?"dark":"light";t._resolvedTheme=n,t._themeColors={...ge(n),...t.themeColors||{}},Ee(t)})}};function Oe(){return{theme:"auto",primaryColor:"#7B3FF2",accentColor:"#3F8CFF",logoUrl:"",botName:"BotStitch Assistant",greeting:"\u{1F44B} Hi there! How can I help you with BotStitch today?",placeholder:"Type your message...",position:"bottom-right",showBranding:!0,webhookUrl:"",premium:!1}}function ge(e){return e==="dark"?{bg:"#181A20",msgBg:"#23262F",headerBg:"linear-gradient(90deg, #23286B, #3F8CFF)",text:"#F3F6FC",accent:"#3F8CFF",userMsgBg:"#23262F",userMsgText:"#F3F6FC",botMsgBg:"#2D3748",botMsgText:"#F3F6FC",inputBg:"#23262F",inputText:"#F3F6FC",border:"#23262F",sendBtn:"#3F8CFF"}:{bg:"#fff",msgBg:"#f9fafb",headerBg:"linear-gradient(90deg, #7B3FF2, #3F8CFF)",text:"#222",accent:"#7B3FF2",userMsgBg:"#f3f4f6",userMsgText:"#222",botMsgBg:"#7B3FF2",botMsgText:"#fff",inputBg:"#fff",inputText:"#222",border:"#e5e7eb",sendBtn:"#7B3FF2"}}function Se(){let e=localStorage.getItem("botstitch_session_id");return e||(e="sess_"+Math.random().toString(36).substr(2,12)+"_"+Date.now(),localStorage.setItem("botstitch_session_id",e)),e}function xe(){let e=navigator.userAgent;return/Mobi|Android/i.test(e)?"mobile":"desktop"}function Ee(e){let t=document.getElementById("botstitch-widget-container");t&&t.remove();let o=e._resolvedTheme,r=e._themeColors,n=document.createElement("div");n.id="botstitch-widget-container",n.style.position="fixed",n.style[e.position.split("-")[1]]="24px",n.style[e.position.split("-")[0]]="24px",n.style.zIndex=9999;let s=document.createElement("button");s.id="botstitch-bubble",s.style.background=r.headerBg,s.style.width=s.style.height="56px",s.style.borderRadius="50%",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.boxShadow="0 4px 16px rgba(0,0,0,0.18)",s.style.cursor="pointer",s.style.transition="transform 0.2s",s.onmouseenter=()=>s.style.transform="scale(1.08)",s.onmouseleave=()=>s.style.transform="scale(1)",s.innerHTML=e.logoUrl&&e.premium?`<img src="${e.logoUrl}" alt="logo" style="width:32px;height:32px;border-radius:8px;" />`:'<svg width="28" height="28" fill="none" stroke="#fff" stroke-width="2"><circle cx="14" cy="14" r="12" /></svg>';let i=document.createElement("div");i.id="botstitch-chat-window",i.style.display="none",i.style.width="360px",i.style.maxWidth="95vw",i.style.height="480px",i.style.maxHeight="80vh",i.style.background=r.bg,i.style.borderRadius="18px",i.style.boxShadow="0 8px 32px rgba(0,0,0,0.16)",i.style.position="absolute",i.style.bottom="72px",i.style.right="0",i.style.overflow="hidden",i.style.display="flex",i.style.flexDirection="column",i.style.transition="opacity 0.2s";let c=document.createElement("div");c.style.background=r.headerBg,c.style.color=r.text,c.style.padding="16px",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="space-between",c.innerHTML=`
    <div style="display:flex;align-items:center;gap:10px;">
      ${e.logoUrl&&e.premium?`<img src="${e.logoUrl}" alt="logo" style="width:32px;height:32px;border-radius:8px;" />`:'<svg width="28" height="28" fill="none" stroke="#fff" stroke-width="2"><circle cx="14" cy="14" r="12" /></svg>'}
      <div>
        <div style="font-weight:600;font-size:16px;">${e.botName}</div>
        <div style="font-size:12px;opacity:0.85;">Online now</div>
      </div>
    </div>
    <button id="botstitch-close-btn" style="background:none;border:none;color:#fff;cursor:pointer;font-size:22px;">&times;</button>
  `;let a=document.createElement("div");a.id="botstitch-messages",a.style.flex="1",a.style.padding="16px",a.style.overflowY="auto",a.style.background=r.msgBg,a.innerHTML=`<div class="bot-msg" style="background:${r.botMsgBg};color:${r.botMsgText};padding:12px 16px;border-radius:14px 14px 4px 14px;max-width:80%;margin-bottom:8px;">${e.greeting}</div>`;let f=document.createElement("div");f.style.padding="16px",f.style.borderTop=`1px solid ${r.border}`,f.style.background=r.inputBg,f.innerHTML=`
    <div style="display:flex;gap:8px;align-items:center;">
      <input id="botstitch-input" type="text" placeholder="${e.placeholder}" style="flex:1;padding:10px 14px;border:1px solid ${r.border};border-radius:8px;font-size:15px;outline:none;background:${r.inputBg};color:${r.inputText};" />
      <input id="botstitch-file" type="file" style="display:none;" ${e.premium?"multiple":""} accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" />
      <button id="botstitch-attach" title="Attach file" style="background:none;border:none;cursor:pointer;font-size:18px;color:${r.accent};"><svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 13V7a5 5 0 0 1 10 0v6a5 5 0 0 1-10 0V8"/></svg></button>
      <button id="botstitch-send" style="background:${r.sendBtn};color:#fff;border:none;padding:10px 18px;border-radius:8px;cursor:pointer;font-weight:500;font-size:15px;">Send</button>
    </div>
  `;let w="";e.premium?e.showFooter&&e.footer?w=`<span>${e.footer}</span>`:w="":w="<span>Powered by BotStitch</span>";let h=document.createElement("div");if(h.style.padding="8px 0 12px 0",h.style.textAlign="center",h.style.fontSize="12px",h.style.color="#aaa",h.innerHTML=w,e.premium){let u=document.createElement("input");u.type="file",u.accept="image/*",u.style.margin="8px 0 0 16px",u.onchange=m=>{alert("Logo upload is handled in the dashboard for premium users.")},c.appendChild(u)}i.appendChild(c),i.appendChild(a),i.appendChild(f),i.appendChild(h),n.appendChild(s),n.appendChild(i),document.body.appendChild(n),s.onclick=()=>{i.style.display=i.style.display==="none"?"flex":"none",i.style.display==="flex"?setTimeout(()=>i.style.opacity="1",10):i.style.opacity="0"},c.querySelector("#botstitch-close-btn").onclick=()=>{i.style.display="none"},f.querySelector("#botstitch-attach").onclick=()=>{f.querySelector("#botstitch-file").click()},f.querySelector("#botstitch-file").onchange=async u=>{let m=Array.from(u.target.files);if(!m.length)return;let y=[];for(let g of m){let p=new FormData;p.append("file",g),p.append("sessionId",Se()),p.append("timestamp",new Date().toISOString()),p.append("source","web"),p.append("userAgent",navigator.userAgent),p.append("platform",xe()),p.append("metadata",JSON.stringify(e.metadata||{}));let T=e.n8nChatUrl||e.webhookUrl;try{let O=await fetch(T,{method:"POST",body:p});if(O.ok){let G=await O.json();G.fileUrl&&y.push(G.fileUrl)}}catch(O){}}y.forEach(g=>{let p=document.createElement("div");p.className="user-msg",p.style.background=e._themeColors.userMsgBg,p.style.color=e._themeColors.userMsgText,p.style.padding="12px 16px",p.style.borderRadius="14px 14px 14px 4px",p.style.maxWidth="80%",p.style.margin="8px 0 8px auto",p.innerHTML=`<a href="${g}" target="_blank" rel="noopener">\u{1F4CE} File</a>`,a.appendChild(p),a.scrollTop=a.scrollHeight}),u.target.value=""},f.querySelector("#botstitch-send").onclick=async()=>{let u=f.querySelector("#botstitch-input");if(u.value.trim()){let m=document.createElement("div");m.className="user-msg",m.style.background=e._themeColors.userMsgBg,m.style.color=e._themeColors.userMsgText,m.style.padding="12px 16px",m.style.borderRadius="14px 14px 14px 4px",m.style.maxWidth="80%",m.style.margin="8px 0 8px auto",m.innerText=u.value,a.appendChild(m),a.scrollTop=a.scrollHeight;let y={message:u.value,sessionId:Se(),timestamp:new Date().toISOString(),source:"web",userAgent:navigator.userAgent,platform:xe(),metadata:e.metadata||{},fileUrls:[]},g=e.n8nChatUrl||e.webhookUrl;try{await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)})}catch(p){}u.value=""}}}})();
